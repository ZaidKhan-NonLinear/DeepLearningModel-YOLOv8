{% extends 'detector/base.html' %}
{% load static %}

{% block title %}YOLO Object Detection - Upload Image{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-10">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="display-4 text-primary">
                <i class="fas fa-eye"></i> Object Detection - Space Station
            </h1>
            <p class="lead text-muted">
                Upload an image to detect objects using our trained YOLO model
            </p>
            <p class="text-muted">This model is trained to detect 'Saftey Equipments' on a sythenthic dataset of space station images</p>
            <p class="text-muted">The sythenthic dataset is created by using Falcon by DualityAI</p>
        </div>

        <!-- Upload Section -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-cloud-upload-alt"></i> Upload Image
                </h5>
            </div>
            <div class="card-body">
                <!-- Drag and Drop Area -->
                <div id="dropZone" class="drop-zone text-center p-5 border-2 border-dashed border-primary rounded">
                    <div id="dropZoneContent">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h4>Drag & Drop your image here</h4>
                        <p class="text-muted">or click to browse files</p>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                            <i class="fas fa-folder-open"></i> Choose File
                        </button>
                    </div>
                </div>

                <!-- Hidden File Input -->
                <input type="file" id="imageInput" class="d-none" accept="image/*">
                
                <!-- CSRF Token -->
                {% csrf_token %}

                <!-- Image Preview -->
                <div id="imagePreview" class="mt-4 text-center" style="display: none;">
                    <h5>Image Preview</h5>
                    <img id="previewImg" class="img-fluid rounded shadow" style="max-height: 300px;">
                    <div class="mt-3">
                        <button id="analyzeBtn" class="btn btn-success btn-lg">
                            <i class="fas fa-search"></i> Analyze Image
                        </button>
                        <button id="clearBtn" class="btn btn-outline-secondary ms-2">
                            <i class="fas fa-times"></i> Clear
                        </button>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Analyzing image...</p>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="resultsSection" class="card shadow-lg" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0">
                    <i class="fas fa-chart-bar"></i> Detection Results
                </h5>
            </div>
            <div class="card-body">
                <!-- Summary Stats -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white text-center">
                            <div class="card-body">
                                <h3 id="totalDetections" class="card-title">0</h3>
                                <p class="card-text">Total Objects</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white text-center">
                            <div class="card-body">
                                <h3 id="uniqueClasses" class="card-title">0</h3>
                                <p class="card-text">Unique Classes</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white text-center">
                            <div class="card-body">
                                <h3 id="avgConfidence" class="card-title">0%</h3>
                                <p class="card-text">Avg Confidence</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white text-center">
                            <div class="card-body">
                                <h3 id="processingTime" class="card-title">0s</h3>
                                <p class="card-text">Processing Time</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Class Distribution Chart -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Object Distribution</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="classChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h6 class="mb-0">Confidence Distribution</h6>
                            </div>
                            <div class="card-body">
                                <canvas id="confidenceChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Detailed Results Table -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="mb-0">Detailed Detection Results</h6>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="table-dark">
                                    <tr>
                                        <th>#</th>
                                        <th>Class</th>
                                        <th>Confidence</th>
                                        <th>Position (X, Y)</th>
                                        <th>Size (W Ã— H)</th>
                                        <th>Bounding Box</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsTableBody">
                                    <!-- Results will be populated here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center mt-4">
                    <button id="downloadResultsBtn" class="btn btn-outline-primary">
                        <i class="fas fa-download"></i> Download Results
                    </button>
                    <button id="newAnalysisBtn" class="btn btn-primary ms-2">
                        <i class="fas fa-plus"></i> New Analysis
                    </button>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorMessage"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let currentFile = null;
    let detectionResults = null;
    let classChart = null;
    let confidenceChart = null;

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM Content Loaded - Initializing app...');
        
        try {
            initializeDropZone();
            initializeEventListeners();
            initializeDragAndDropSupport();
            console.log('App initialized successfully');
        } catch (error) {
            console.error('Error initializing app:', error);
            showError('Error initializing the application. Please refresh the page.');
        }
    });

    // Check for drag and drop support
    function initializeDragAndDropSupport() {
        const dropZone = document.getElementById('dropZone');
        if (!dropZone) return;
        
        // Check if drag and drop is supported
        const div = document.createElement('div');
        const isDragDropSupported = (('draggable' in div) || ('ondragstart' in div && 'ondrop' in div)) && 
                                   'FormData' in window && 'FileReader' in window;
        
        if (!isDragDropSupported) {
            console.warn('Drag and drop not supported in this browser');
            dropZone.style.opacity = '0.7';
            dropZone.title = 'Drag and drop not supported. Please use the file browser.';
        } else {
            console.log('Drag and drop is supported');
        }
    }
</script>
{% endblock %}
