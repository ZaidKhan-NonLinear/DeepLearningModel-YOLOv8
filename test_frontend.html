<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="test-token">
    <title>File Upload Test</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <h1>File Upload Test</h1>
        
        <!-- Upload Section -->
        <div class="card shadow-lg mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Upload Image</h5>
            </div>
            <div class="card-body">
                <!-- Drag and Drop Area -->
                <div id="dropZone" class="drop-zone text-center p-5 border-2 border-dashed border-primary rounded">
                    <div id="dropZoneContent">
                        <i class="fas fa-cloud-upload-alt fa-3x text-primary mb-3"></i>
                        <h4>Drag & Drop your image here</h4>
                        <p class="text-muted">or click to browse files</p>
                        <button type="button" class="btn btn-outline-primary" onclick="document.getElementById('imageInput').click()">
                            Choose File
                        </button>
                    </div>
                </div>

                <!-- Hidden File Input -->
                <input type="file" id="imageInput" class="d-none" accept="image/*">

                <!-- Image Preview -->
                <div id="imagePreview" class="mt-4 text-center" style="display: none;">
                    <h5>Image Preview</h5>
                    <img id="previewImg" class="img-fluid rounded shadow" style="max-height: 300px;">
                    <div class="mt-3">
                        <button id="analyzeBtn" class="btn btn-success btn-lg">
                            Analyze Image
                        </button>
                        <button id="clearBtn" class="btn btn-outline-secondary ms-2">
                            Clear
                        </button>
                    </div>
                </div>

                <!-- Loading Spinner -->
                <div id="loadingSpinner" class="text-center mt-4" style="display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Analyzing image...</p>
                </div>
            </div>
        </div>

        <!-- Error Alert -->
        <div id="errorAlert" class="alert alert-danger alert-dismissible fade" role="alert" style="display: none;">
            <span id="errorMessage"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        let currentFile = null;

        // Utility function to get CSRF token
        function getCSRFToken() {
            const metaTag = document.querySelector('meta[name="csrf-token"]');
            return metaTag ? metaTag.getAttribute('content') : '';
        }

        // Initialize drop zone functionality
        function initializeDropZone() {
            const dropZone = document.getElementById('dropZone');
            const imageInput = document.getElementById('imageInput');
            
            // Prevent default drag behaviors
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            // Highlight drop zone when item is dragged over it
            ['dragenter', 'dragover'].forEach(eventName => {
                dropZone.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, unhighlight, false);
            });
            
            // Handle dropped files
            dropZone.addEventListener('drop', handleDrop, false);
            
            // Handle file input change
            imageInput.addEventListener('change', handleFileSelect, false);
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            function highlight(e) {
                dropZone.classList.add('dragover');
            }
            
            function unhighlight(e) {
                dropZone.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFiles(files);
                }
            }
            
            function handleFileSelect(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            }
        }

        // Handle uploaded files
        function handleFiles(files) {
            const file = files[0];
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                showError('Please select a valid image file.');
                return;
            }
            
            // Validate file size (10MB limit)
            if (file.size > 10 * 1024 * 1024) {
                showError('File size too large. Maximum size is 10MB.');
                return;
            }
            
            currentFile = file;
            showImagePreview(file);
        }

        // Show image preview
        function showImagePreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const previewImg = document.getElementById('previewImg');
                const imagePreview = document.getElementById('imagePreview');
                const dropZoneContent = document.getElementById('dropZoneContent');
                
                previewImg.src = e.target.result;
                imagePreview.style.display = 'block';
                dropZoneContent.style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        // Initialize event listeners
        function initializeEventListeners() {
            // Analyze button
            document.getElementById('analyzeBtn').addEventListener('click', analyzeImage);
            
            // Clear button
            document.getElementById('clearBtn').addEventListener('click', clearAll);
        }

        // Analyze the uploaded image
        async function analyzeImage() {
            if (!currentFile) {
                showError('Please select an image first.');
                return;
            }
            
            // Show loading spinner
            showLoading(true);
            hideError();
            
            try {
                const formData = new FormData();
                formData.append('image', currentFile);
                
                const response = await fetch('/predict/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': getCSRFToken()
                    }
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Analysis successful! Check console for details.');
                    console.log('Analysis result:', result);
                } else {
                    showError(result.error || 'Analysis failed. Please try again.');
                }
            } catch (error) {
                showError('Network error. Please check your connection and try again.');
                console.error('Error:', error);
            } finally {
                showLoading(false);
            }
        }

        // Show/hide loading spinner
        function showLoading(show) {
            const spinner = document.getElementById('loadingSpinner');
            const analyzeBtn = document.getElementById('analyzeBtn');
            
            if (show) {
                spinner.style.display = 'block';
                analyzeBtn.disabled = true;
                analyzeBtn.innerHTML = 'Analyzing...';
            } else {
                spinner.style.display = 'none';
                analyzeBtn.disabled = false;
                analyzeBtn.innerHTML = 'Analyze Image';
            }
        }

        // Show error message
        function showError(message) {
            const errorAlert = document.getElementById('errorAlert');
            const errorMessage = document.getElementById('errorMessage');
            
            errorMessage.textContent = message;
            errorAlert.style.display = 'block';
            errorAlert.classList.add('show');
        }

        // Hide error message
        function hideError() {
            const errorAlert = document.getElementById('errorAlert');
            errorAlert.style.display = 'none';
            errorAlert.classList.remove('show');
        }

        // Clear all data
        function clearAll() {
            // Reset file input
            document.getElementById('imageInput').value = '';
            currentFile = null;
            
            // Hide preview
            document.getElementById('imagePreview').style.display = 'none';
            
            // Show drop zone content
            document.getElementById('dropZoneContent').style.display = 'block';
            
            // Hide error
            hideError();
            
            // Reset button
            const analyzeBtn = document.getElementById('analyzeBtn');
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = 'Analyze Image';
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            initializeDropZone();
            initializeEventListeners();
        });
    </script>
</body>
</html>
